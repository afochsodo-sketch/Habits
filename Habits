
<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Habit Tracker</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{--bg:#f4f6f8;--card:#fff;--text:#000;--accent:#4caf50;}
.dark{--bg:#121212;--card:#1e1e1e;--text:#fff;}
body{margin:0;background:var(--bg);font-family:system-ui;color:var(--text);}
.app{max-width:420px;margin:auto;padding:16px;}
header{display:flex;justify-content:space-between;align-items:center;}
button,input{border:none;border-radius:10px;padding:8px;}
.month{display:flex;justify-content:space-between;margin:10px 0;}
.habit{background:var(--card);padding:12px;border-radius:14px;margin-bottom:14px;}
.days{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;}
.days input{width:22px;height:22px;}
.progress{background:#bbb;height:10px;border-radius:10px;margin-top:8px;}
.bar{height:100%;background:var(--accent);width:0%;}
.note{width:100%;margin-top:6px;}
.add,.backup{display:flex;gap:6px;margin:10px 0;}
.small{font-size:13px;opacity:.8;}
canvas{background:var(--card);border-radius:12px;padding:8px;}
</style>
</head>

<body>
<div class="app">

<header>
<h2>Gewohnheiten</h2>
<div>
<button id="notify">ğŸ””</button>
<button id="dark">ğŸŒ™</button>
</div>
</header>

<div class="add">
<input id="newHabit" placeholder="Neue Gewohnheit">
<button onclick="addHabit()">â•</button>
</div>

<div class="backup">
<button onclick="exportData()">ğŸ’¾ Export</button>
<input type="file" id="importFile" hidden>
<button onclick="document.getElementById('importFile').click()">ğŸ“‚ Import</button>
</div>

<div class="month">
<button onclick="changeMonth(-1)">â—€</button>
<b id="month"></b>
<button onclick="changeMonth(1)">â–¶</button>
</div>

<div id="habits"></div>

<h3>Wochenstatistik</h3>
<div id="weekStats" class="small"></div>

<h3>Jahresstatistik</h3>
<canvas id="yearChart"></canvas>

</div>

<script>
let habits = JSON.parse(localStorage.getItem("habits")) || [
  "Bibellesen","Kein Social Media","FrÃ¼h schlafen"
];

let date = new Date();
const habitsDiv = document.getElementById("habits");

function saveHabits(){
  localStorage.setItem("habits", JSON.stringify(habits));
  render();
}

function addHabit(){
  const val = newHabit.value.trim();
  if(val && !habits.includes(val)){
    habits.push(val);
    saveHabits();
    newHabit.value="";
  }
}

function removeHabit(h){
  if(confirm("Gewohnheit lÃ¶schen?")){
    habits = habits.filter(x=>x!==h);
    saveHabits();
  }
}

function render(){
  habitsDiv.innerHTML="";
  month.textContent = date.toLocaleDateString("de-DE",{month:"long",year:"numeric"});
  const daysInMonth = new Date(date.getFullYear(),date.getMonth()+1,0).getDate();

  habits.forEach(h=>{
    const card = document.createElement("div");
    card.className="habit";
    card.innerHTML=`
      <h3>${h} <button onclick="removeHabit('${h}')">âŒ</button></h3>
      <div class="days"></div>
      <div class="progress"><div class="bar"></div></div>
      <textarea class="note" placeholder="Notiz..."></textarea>
    `;

    const days = card.querySelector(".days");
    const bar = card.querySelector(".bar");
    const note = card.querySelector(".note");

    note.value = localStorage.getItem(`note-${h}`)||"";
    note.oninput = ()=>localStorage.setItem(`note-${h}`, note.value);

    for(let d=1; d<=daysInMonth; d++){
      const cb=document.createElement("input");
      cb.type="checkbox";
      const key=`${h}-${date.getFullYear()}-${date.getMonth()}-${d}`;
      cb.checked = localStorage.getItem(key)==="1";
      cb.onchange=()=>{
        if(cb.checked) localStorage.setItem(key,"1");
        else localStorage.removeItem(key);
        update();
      };
      days.appendChild(cb);
    }

    function update(){
      const checked=[...days.children].filter(c=>c.checked).length;
      bar.style.width=(checked/daysInMonth*100)+"%";
      updateWeek();
      updateYear();
    }
    update();
    habitsDiv.appendChild(card);
  });

  updateWeek();
  updateYear();
}

function updateWeek(){
  let total=0,done=0;
  const now=new Date();
  habits.forEach(h=>{
    for(let i=0;i<7;i++){
      const d=new Date(now);
      d.setDate(now.getDate()-i);
      const key=`${h}-${d.getFullYear()}-${d.getMonth()}-${d.getDate()}`;
      total++;
      if(localStorage.getItem(key)==="1") done++;
    }
  });
  weekStats.textContent = `Diese Woche: ${Math.round(done/total*100)||0}% erledigt`;
}

let yearChart;
function updateYear(){
  const data = habits.map(h=>{
    let c=0;
    for(let i=0;i<localStorage.length;i++){
      const key=localStorage.key(i);
      if(key.startsWith(h) && localStorage.getItem(key)==="1") c++;
    }
    return c;
  });

  if(yearChart) yearChart.destroy();
  yearChart=new Chart(yearChart=document.getElementById("yearChart"),{
    type:"bar",
    data:{labels:habits,datasets:[{data,backgroundColor:"#4caf50"}]},
    options:{plugins:{legend:{display:false}}}
  });
}

function changeMonth(n){
  date.setMonth(date.getMonth()+n);
  render();
}

/* DARK MODE */
dark.onclick=()=>{
  document.body.classList.toggle("dark");
  localStorage.setItem("dark",document.body.classList.contains("dark"));
}
if(localStorage.getItem("dark")==="true") document.body.classList.add("dark");

/* NOTIFICATION */
notify.onclick=()=>{
  Notification.requestPermission().then(p=>{
    if(p==="granted") new Notification("Zeit fÃ¼r deine Gewohnheiten ğŸ’ª");
  });
}

/* EXPORT */
function exportData(){
  const data = {};
  for(let i=0;i<localStorage.length;i++){
    const k = localStorage.key(i);
    data[k]=localStorage.getItem(k);
  }
  const blob = new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "habit-backup.json";
  a.click();
}

/* IMPORT */
importFile.onchange = e=>{
  const file = e.target.files[0];
  if(!file) return;
  const reader=new FileReader();
  reader.onload=()=>{
    const data = JSON.parse(reader.result);
    localStorage.clear();
    for(const k in data) localStorage.setItem(k,data[k]);
    location.reload();
  };
  reader.readAsText(file);
};

render();
</script>
</body>
</html>
