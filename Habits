<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gewohnheiten</title>

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#4caf50">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{--bg:#f4f6f8;--card:#fff;--text:#000;--accent:#4caf50;}
.dark{--bg:#121212;--card:#1e1e1e;--text:#fff;}
body{margin:0;background:var(--bg);font-family:system-ui;color:var(--text);}
.app{max-width:420px;margin:auto;padding:16px;}
header{display:flex;justify-content:space-between;align-items:center;}
button,input,textarea{border:none;border-radius:10px;padding:8px;}
.habit{background:var(--card);padding:12px;border-radius:14px;margin-bottom:14px;}
.days{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;}
.days input{width:22px;height:22px;}
.progress{background:#bbb;height:10px;border-radius:10px;margin-top:8px;}
.bar{height:100%;background:var(--accent);width:0%;}
.add,.backup{display:flex;gap:6px;margin:10px 0;}
canvas{background:var(--card);border-radius:12px;padding:8px;}
.small{font-size:13px;opacity:.8;}
</style>
</head>

<body>
<div class="app">

<header>
<h2>Gewohnheiten</h2>
<div>
<button id="notify">ğŸ””</button>
<button id="dark">ğŸŒ™</button>
</div>
</header>

<div class="add">
<input id="newHabit" placeholder="Neue Gewohnheit">
<button onclick="addHabit()">â•</button>
</div>

<div class="backup">
<button onclick="exportData()">ğŸ“¤ Export</button>
<input type="file" id="importFile" hidden>
<button onclick="document.getElementById('importFile').click()">ğŸ“¥ Import</button>
</div>

<div class="month">
<button onclick="changeMonth(-1)">â—€</button>
<b id="month"></b>
<button onclick="changeMonth(1)">â–¶</button>
</div>

<div id="habits"></div>

<h3>Wochenstatistik</h3>
<div id="weekStats" class="small"></div>

<h3>Jahresstatistik</h3>
<canvas id="yearChart"></canvas>

</div>

<script>
let habits = JSON.parse(localStorage.getItem("habits")) || [
  "Bibellesen","Kein Social Media","FrÃ¼h schlafen"
];

let date = new Date();
const habitsDiv = document.getElementById("habits");

function save(){
  localStorage.setItem("habits", JSON.stringify(habits));
  render();
}

function addHabit(){
  const v = newHabit.value.trim();
  if(v && !habits.includes(v)){
    habits.push(v);
    newHabit.value="";
    save();
  }
}

function removeHabit(h){
  if(confirm("Gewohnheit lÃ¶schen?")){
    habits = habits.filter(x=>x!==h);
    save();
  }
}

function render(){
  habitsDiv.innerHTML="";
  month.textContent = date.toLocaleDateString("de-DE",{month:"long",year:"numeric"});
  const daysInMonth = new Date(date.getFullYear(),date.getMonth()+1,0).getDate();

  habits.forEach(h=>{
    const card=document.createElement("div");
    card.className="habit";
    card.innerHTML=`
      <h3>${h} <button onclick="removeHabit('${h}')">âŒ</button></h3>
      <div class="days"></div>
      <div class="progress"><div class="bar"></div></div>
      <textarea placeholder="Notiz..."></textarea>
    `;

    const days=card.querySelector(".days");
    const bar=card.querySelector(".bar");
    const note=card.querySelector("textarea");

    note.value = localStorage.getItem("note-"+h) || "";
    note.oninput=()=>localStorage.setItem("note-"+h,note.value);

    for(let d=1;d<=daysInMonth;d++){
      const cb=document.createElement("input");
      cb.type="checkbox";
      const key=`${h}-${date.getFullYear()}-${date.getMonth()}-${d}`;
      cb.checked = localStorage.getItem(key)==="1";
      cb.onchange=()=>{
        if(cb.checked) localStorage.setItem(key,"1");
        else localStorage.removeItem(key);
        update();
      };
      days.appendChild(cb);
    }

    function update(){
      const checked=[...days.children].filter(c=>c.checked).length;
      bar.style.width=(checked/daysInMonth*100)+"%";
      updateWeek();
      updateYear();
    }
    update();

    habitsDiv.appendChild(card);
  });
}

function updateWeek(){
  let total=0,done=0;
  for(let h of habits){
    for(let i=0;i<7;i++){
      const d=new Date(); d.setDate(d.getDate()-i);
      const key=`${h}-${d.getFullYear()}-${d.getMonth()}-${d.getDate()}`;
      total++;
      if(localStorage.getItem(key)==="1") done++;
    }
  }
  weekStats.textContent=`Diese Woche: ${total?Math.round(done/total*100):0}%`;
}

let chart;
function updateYear(){
  const data=habits.map(h=>{
    let c=0;
    for(let k in localStorage)
      if(k.startsWith(h+"-") && localStorage[k]==="1") c++;
    return c;
  });
  if(chart) chart.destroy();
  chart=new Chart(yearChart,{
    type:"bar",
    data:{labels:habits,datasets:[{data,backgroundColor:"#4caf50"}]},
    options:{plugins:{legend:{display:false}}}
  });
}

function changeMonth(n){date.setMonth(date.getMonth()+n);render();}

dark.onclick=()=>{
  document.body.classList.toggle("dark");
  localStorage.setItem("dark",document.body.classList.contains("dark"));
};
if(localStorage.getItem("dark")==="true")document.body.classList.add("dark");

notify.onclick=()=>{
  Notification.requestPermission().then(p=>{
    if(p==="granted") new Notification("Zeit fÃ¼r deine Gewohnheiten ğŸ’ª");
  });
};

function exportData(){
  const data=JSON.stringify(localStorage);
  const a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([data],{type:"application/json"}));
  a.download="habits-backup.json";
  a.click();
}

importFile.onchange=e=>{
  const r=new FileReader();
  r.onload=()=>{const d=JSON.parse(r.result);for(let k in d)localStorage.setItem(k,d[k]);render();}
  r.readAsText(e.target.files[0]);
};

render();
</script>

<script>
if("serviceWorker" in navigator){
  navigator.serviceWorker.register("service-worker.js");
}
</script>

</body>
</html>
